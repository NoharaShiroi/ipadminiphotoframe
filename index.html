<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google 相簿數位相框</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://apis.google.com/js/api.js"></script> <!-- 加载 Google API -->
</head>
<body>

    <!-- 🔹 授權登入 -->
    <div id="auth-container">
        <h1>Google 相簿 數位相框</h1>
        <button id="authorize-btn">使用 Google 帳戶登入</button>
    </div>

    <!-- 🔹 相簿選擇 -->
    <div id="app-container" style="display: none;">
        <button id="back-to-album-btn" style="display: none;">選擇其他相簿</button>
        <div id="album-selection-container">
            <h2>選擇相簿</h2>
            <select id="album-select" onchange="app.loadPhotos()">
                <option value="all">所有相片</option>
                <!-- 动态生成的相簿选项 -->
            </select>
        </div>

        <!-- 🔹 相片顯示區 -->
        <div id="photo-container" style="display: none;"></div>
    </div>

    <script>
        const app = {
            CLIENT_ID: "1004388657829-mvpott95dsl5bapu40vi2n5li7i7t7d1.apps.googleusercontent.com", // 替换为你的客户端 ID
            REDIRECT_URI: "https://noharashiroi.github.io/photo-frame/", // 替换为你的重定向 URI
            SCOPES: "https://www.googleapis.com/auth/photoslibrary.readonly",
            accessToken: sessionStorage.getItem("access_token") || null,
            albumId: null,
            photos: [],
            currentPhotoIndex: 0,
            nextPageToken: null,
            slideshowInterval: null, // 定时器的引用
            isPlaying: true, // 播放状态

            getAccessToken: function() {
                var hashParams = new URLSearchParams(window.location.hash.substring(1));
                if (hashParams.has("access_token")) {
                    this.accessToken = hashParams.get("access_token");
                    sessionStorage.setItem("access_token", this.accessToken);
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
                if (this.accessToken) {
                    document.getElementById("auth-container").style.display = "none";
                    document.getElementById("app-container").style.display = "flex";
                    this.fetchAlbums();
                    this.fetchAllPhotos();  // 在授权后预加载所有照片
                } else {
                    document.getElementById("auth-container").style.display = "flex";
                    document.getElementById("app-container").style.display = "none";
                }
            },

            authorizeUser: function() {
                var authUrl = `https://accounts.google.com/o/oauth2/auth?client_id=${this.CLIENT_ID}&redirect_uri=${encodeURIComponent(this.REDIRECT_URI)}&response_type=token&scope=${this.SCOPES}&prompt=consent`;
                window.location.href = authUrl;
            },

            fetchAlbums: function() {
                if (!this.accessToken) return;
                var url = "https://photoslibrary.googleapis.com/v1/albums?pageSize=50";

                fetch(url, {
                    method: "GET",
                    headers: { "Authorization": "Bearer " + this.accessToken }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Network response was not ok: " + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.albums) {
                        this.renderAlbumList(data.albums);
                    }
                })
                .catch(error => {
                    console.error("Error fetching albums:", error);
                });
            },

            renderAlbumList: function(albums) {
                var albumSelect = document.getElementById("album-select");
                albumSelect.innerHTML = '<option value="all">所有相片</option>'; // 去掉多余的选项
                albums.forEach(album => {
                    var option = document.createElement("option");
                    option.value = album.id;
                    option.textContent = album.title;
                    albumSelect.appendChild(option);
                });
            },

            loadPhotos: function() {
                const albumSelect = document.getElementById("album-select");
                this.albumId = albumSelect.value === "all" ? null : albumSelect.value;

                if (this.albumId) {
                    this.fetchPhotos();
                } else {
                    this.fetchAllPhotos(); // 加载所有照片
                }
            },

            fetchAllPhotos: function() {
                const url = "https://photoslibrary.googleapis.com/v1/mediaItems:search";
                const body = {
                    pageSize: 50,
                    pageToken: this.nextPageToken || ''
                };

                fetch(url, {
                    method: "POST",
                    headers: { "Authorization": "Bearer " + this.accessToken, "Content-Type": "application/json" },
                    body: JSON.stringify(body)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Network response was not ok: " + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.mediaItems) {
                        this.photos = [...this.photos, ...data.mediaItems];
                        this.nextPageToken = data.nextPageToken;
                        this.renderPhotos();
                    } else {
                        console.error("No mediaItems found in the response.");
                    }
                })
                .catch(error => {
                    console.error("Error fetching photos:", error);
                });
            },

            fetchPhotos: function() {
                var url = "https://photoslibrary.googleapis.com/v1/mediaItems:search";
                var body = {
                    albumId: this.albumId,
                    pageSize: 50
                };

                fetch(url, {
                    method: "POST",
                    headers: { "Authorization": "Bearer " + this.accessToken, "Content-Type": "application/json" },
                    body: JSON.stringify(body)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Network response was not ok: " + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.mediaItems) {
                        this.photos = data.mediaItems;
                        this.renderPhotos();
                    } else {
                        console.error("No mediaItems found in the response.");
                    }
                })
                .catch(error => {
                    console.error("Error fetching photos:", error);
                });
            },

            renderPhotos: function() {
                var photoContainer = document.getElementById("photo-container");
                photoContainer.innerHTML = '';  // 清空照片容器

                if (this.photos.length === 0) {
                    photoContainer.innerHTML = "<p>此相簿沒有照片</p>";
                } else {
                    this.startSlideshow(); // 开始幻灯片播放
                }

                photoContainer.style.display = "grid";
                document.getElementById("app-container").style.display = "flex"; // 显示相片容器
            },

            startSlideshow: function() {
                if (this.photos.length > 0) {
                    this.currentPhotoIndex = 0; // 从第一张开始循环
                    document.body.requestFullscreen(); // 进入全屏模式
                    this.showCurrentPhoto();
                    this.autoChangePhoto();
                }
            },

            showCurrentPhoto: function() {
                var photoElement = document.createElement("img");
                photoElement.src = `${this.photos[this.currentPhotoIndex].baseUrl}=w1200-h800`;
                photoElement.style.position = "fixed";
                photoElement.style.top = "0";
                photoElement.style.left = "0";
                photoElement.style.width = "100%";
                photoElement.style.height = "100%";
                photoElement.style.objectFit = "cover"; // 保持比例填充
                document.body.innerHTML = ""; // 清空内容
                document.body.appendChild(photoElement);
                this.addGestureControls();
            },

            autoChangePhoto: function() {
                this.slideshowInterval = setInterval(() => {
                    this.currentPhotoIndex = (this.currentPhotoIndex + 1) % this.photos.length;
                    this.showCurrentPhoto();
                }, 5000); // 每5秒自动切换照片
            },

            addGestureControls: function() {
                let touchStartX = 0;
                let touchEndX = 0;

                // 处理触摸开始事件
                document.addEventListener('touchstart', (e) => {
                    touchStartX = e.touches[0].clientX; // 记录起始触摸位置
                });

                // 处理触摸结束事件
                document.addEventListener('touchend', (e) => {
                    touchEndX = e.changedTouches[0].clientX; // 记录结束触摸位置

                    // 计算滑动方向
                    if (touchEndX < touchStartX - 50) {
                        // 向左滑动，前往下一张照片
                        this.currentPhotoIndex = (this.currentPhotoIndex + 1) % this.photos.length;
                        this.showCurrentPhoto(); // 更新显示的照片
                    } else if (touchEndX > touchStartX + 50) {
                        // 向右滑动，返回上一张照片
                        this.currentPhotoIndex = (this.currentPhotoIndex - 1 + this.photos.length) % this.photos.length;
                        this.showCurrentPhoto(); // 更新显示的照片
                    }
                });

                // 双击事件控制
                document.addEventListener('dblclick', () => {
                    this.toggleSlideshow();
                });
            },

            toggleSlideshow: function() {
                if (this.isPlaying) {
                    clearInterval(this.slideshowInterval); // 清除自动播放
                } else {
                    this.autoChangePhoto(); // 恢复自动播放
                }
                this.isPlaying = !this.isPlaying; // 切换状态
            }

        };

        // 事件监听
        document.getElementById("authorize-btn").onclick = app.authorizeUser.bind(app);

        document.getElementById("back-to-album-btn").onclick = () => {
            document.getElementById("photo-container").style.display = "none";
            document.getElementById("album-selection-container").style.display = "block";
        };

        document.addEventListener("DOMContentLoaded", () => app.getAccessToken());

        // 滚动事件，用于加载更多照片
        window.onscroll = function() {
            if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) {
                app.fetchAllPhotos();
            }
        };
    </script>
</body>
</html>
